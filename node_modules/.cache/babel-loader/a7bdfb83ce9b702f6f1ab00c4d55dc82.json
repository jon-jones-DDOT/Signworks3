{"ast":null,"code":"import _objectSpread from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread\";\nimport _toConsumableArray from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/toConsumableArray\";\nimport _slicedToArray from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";\nimport _classCallCheck from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";\nimport _taggedTemplateLiteral from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/taggedTemplateLiteral\";\nvar _jsxFileName = \"C:\\\\Projects\\\\Signworks3\\\\src\\\\components\\\\esri\\\\map\\\\MapView.js\";\n\nfunction _templateObject() {\n  var data = _taggedTemplateLiteral([\"\\n  height: 100%;\\n  width: 100%;\\n\"]);\n\n  _templateObject = function _templateObject() {\n    return data;\n  };\n\n  return data;\n}\n\n// Copyright 2019 Esri Licensed under the Apache License, Version 2.0 (the\n// \"License\"); you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n// http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law\n// or agreed to in writing, software distributed under the License is\n// distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n// KIND, either express or implied. See the License for the specific language\n// governing permissions and limitations under the License.​ NOTE This is a\n// \"special\" react component that does not strictly play by React's rules.\n//\n// Conceptually, this component creates a \"portal\" in React by closing its\n// render method off from updates (by simply rendering a div and never accepting\n// re-renders) then reconnecting itself to the React lifecycle by listening for\n// any new props (using componentWillReceiveProps) React\nimport React, { Component } from 'react'; // Redux\n\nimport { connect } from 'react-redux';\nimport { bindActionCreators } from 'redux';\nimport { actions as mapActions } from '../../../redux/reducers/map';\nimport { actions as graphicActions } from '../../../redux/reducers/graphic';\nimport { mapModes } from '../../../redux/reducers/graphic'; // ESRI\n\nimport { loadModules } from 'esri-loader';\nimport { createView } from '../../../utils/esriHelper'; // Styled Components\n\nimport styled from 'styled-components';\nimport { pointToExtent } from '../../../utils/JSAPI';\nvar Container = styled.div(_templateObject()); // Variables\n\nvar containerID = \"map-view-container\";\n\nvar MapView =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(MapView, _Component);\n\n  function MapView(props) {\n    var _this;\n\n    _classCallCheck(this, MapView);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(MapView).call(this, props));\n    _this.selPoint = null;\n    _this.markerLayer = null;\n    _this.queryMarkerLayer = null;\n    _this.featureLayer = null;\n    _this.symb = null;\n    _this.addSymb = null;\n    _this.geom = null;\n\n    _this.startup = function (mapConfig, node) {\n      var isScene = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n      createView(mapConfig, node, isScene).then(function (response) {\n        _this.init(response);\n\n        _this.setupWidgetsAndLayers();\n\n        _this.finishedLoading();\n      }, function (error) {\n        console.error(\"maperr\", error);\n        window.setTimeout(function () {\n          _this.startup(mapConfig, node);\n        }, 1000);\n      });\n    };\n\n    _this.finishedLoading = function () {\n      // Update app state only after map and widgets are loaded\n      _this.props.onMapLoaded(_this.view.extent);\n    };\n\n    _this.getSelectedSupport = function (expandedMapPoint) {\n      // this line takes the buffered point and sends it  to the map reducer which\n      // punts it to the _setSupport saga which queries and gets the support, signs,\n      // timebands, etc and writes them to the store, where they dictate the Rightbar\n      // display.  Once the store changes the action picks up in willReceiveProps\n      _this.props.onMapClicked(expandedMapPoint, _this.props.config.featureURLs);\n    };\n\n    _this.mapClickHandler = function (evt) {\n      // in any map app that's more than a viewer, the map click event is gonna be\n      // complicated so much so that I wrote this a month ago and it is already\n      // getting away from me so we shall comment.  The click event is first captured\n      // here then evaluated against the store to decide what it is supposed to do\n      switch (_this.props.graphic.mapClickMode) {\n        //the click is supposed to select an existing support on the map\n        case mapModes.SELECT_SUPPORT_MODE:\n          // this redux call moves info about the view into the store so that an extent\n          // around the point can be calculated I don't think it changes, (todo) see about\n          // moving it to map load or something\n          _this.props.setPointBuffer(_this.view.width, _this.view.extent.width, _this.view.spatialReference); // this creates a small extent buffer around the mapPoint to aid in the select\n          // query its callback is getSelectedSupport, above\n\n\n          pointToExtent(_this.view.width, _this.view.extent.width, _this.view.spatialReference, evt.mapPoint, 12, _this.getSelectedSupport);\n          break;\n        //ok now we are in add support mode\n\n        case mapModes.ADD_SUPPORT_MODE:\n          // we should create a 'fake' feature out of the map click event\n          var newSupportFeature = {\n            atrributes: {},\n            geometry: {\n              x: evt.mapPoint.longitude,\n              y: evt.mapPoint.latitude,\n              type: 'point'\n            } //grabbing a local copy of the mapPoint.geom for the marker\n\n          };\n          console.log('evt.mapPoint', evt.mapPoint);\n\n          _this.setState({\n            newSupportClickGeom: evt.mapPoint\n          });\n\n          _this.props.startStreetSmartViewer([newSupportFeature], _this.props.config.featureURLs, 4326, 2248, _this.props.graphic.viewWidth, _this.props.graphic.viewExtentWidth, _this.props.graphic.view_spatRef, true);\n\n          break;\n\n        default:\n          return;\n      }\n    };\n\n    _this.mapMoveHandler = function (evt) {\n      console.log('this.view.zoom', _this.view.zoom);\n\n      _this.props.onMapChanged(_this.view.extent);\n    };\n\n    _this.init = function (response) {\n      _this.view = response.view;\n      _this.map = response.view.map;\n      console.log('this.view.zoom on init :', _this.view.zoom);\n    };\n\n    _this.setupWidgetsAndLayers = function () {\n      loadModules(['esri/layers/FeatureLayer', \"esri/layers/GraphicsLayer\", 'esri/Graphic', \"esri/layers/TileLayer\", \"esri/Basemap\"]).then(function (_ref) {\n        var _ref2 = _slicedToArray(_ref, 5),\n            FeatureLayer = _ref2[0],\n            GraphicsLayer = _ref2[1],\n            Graphic = _ref2[2],\n            TileLayer = _ref2[3],\n            Basemap = _ref2[4];\n\n        var layerUrl = \"https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/DC_Basemap_LightGray_W\" + \"ebMercator/MapServer\";\n        var baselayer = new TileLayer(layerUrl, null);\n        var baseMap = new Basemap({\n          baseLayers: [baselayer]\n        });\n        _this.featureLayer = new FeatureLayer({\n          url: _this.props.config.featureURLs.supports,\n          definitionExpression: \"SUPPORTSTATUS = 1\",\n          outFields: [\"*\"],\n          id: \"support\"\n        });\n        _this.queryMarkerLayer = new GraphicsLayer();\n        _this.markerLayer = new GraphicsLayer(); //     this.map.basemap = baseMap;\n\n        _this.map.addMany([_this.featureLayer, _this.queryMarkerLayer, _this.markerLayer]);\n\n        _this.view.on(\"click\", _this.mapClickHandler);\n\n        _this.view.on(\"pointer-up\", _this.mapMoveHandler);\n\n        _this.view.on('mouse-wheel', _this.mapMoveHandler);\n\n        _this.symb = {\n          type: \"simple-marker\",\n          // autocasts as new SimpleMarkerSymbol()\n          style: \"circle\",\n          color: [0, 255, 0, 0.0],\n          size: \"30px\",\n          // pixels\n          outline: {\n            // autocasts as new SimpleLineSymbol()\n            color: 'magenta',\n            width: 3 // points\n\n          }\n        };\n        _this.addSymb = {\n          type: \"simple-marker\",\n          // autocasts as new SimpleMarkerSymbol()\n          style: \"circle\",\n          color: [0, 255, 0, 0.0],\n          size: \"30px\",\n          // pixels\n          outline: {\n            // autocasts as new SimpleLineSymbol()\n            color: 'green',\n            width: 3 // points\n\n          }\n        };\n        _this.selPoint = new Graphic({\n          geometry: null,\n          symbol: _this.symb\n        }); //   this.markerLayer.add(this.selPoint)\n      });\n    };\n\n    _this.state = {\n      newSupportClickGeom: null\n    };\n    return _this;\n  }\n\n  _createClass(MapView, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.startup(this.props.mapConfig, containerID, this.props.is3DScene);\n    }\n  }, {\n    key: \"shouldComponentUpdate\",\n    value: function shouldComponentUpdate(nextProps, nextState) {\n      // Tell React to never update this component, that's up to us\n      return false;\n    }\n  }, {\n    key: \"UNSAFE_componentWillReceiveProps\",\n    value: function UNSAFE_componentWillReceiveProps(nextProps) {\n      var _this2 = this;\n\n      //removes superQuery results from view based on store\n      if (nextProps.graphic.showQuery === false) {\n        this.queryMarkerLayer.removeAll();\n      } //if there are query features in the store, this block displays them in the view\n\n\n      if (nextProps.graphic.queryFeatures.length > 0) {\n        var graphics = _toConsumableArray(nextProps.graphic.queryFeatures); // add symbols\n\n\n        var querySymb = {\n          type: \"simple-marker\",\n          // autocasts as new SimpleMarkerSymbol()  NEVER TRUST AUTOCAST\n          style: \"circle\",\n          color: [0, 255, 0, 0.0],\n          size: \"30px\",\n          // pixels\n          outline: {\n            // autocasts as new SimpleLineSymbol()\n            color: 'blue',\n            width: 3 // points\n\n          }\n        }; //this just sets query results in the store to empty array\n\n        this.props.removeQueryResults(); // create graphics and add them to layer\n\n        loadModules([\"esri/Graphic\"]).then(function (_ref3) {\n          var _ref4 = _slicedToArray(_ref3, 1),\n              Graphic = _ref4[0];\n\n          var gr = null;\n\n          for (var i = 0; i < graphics.length; i++) {\n            graphics[i].geometry.type = \"point\";\n            gr = new Graphic({\n              geometry: graphics[i].geometry,\n              symbol: querySymb\n            });\n\n            _this2.queryMarkerLayer.add(gr);\n          }\n        });\n      } //let's see if the support layer has been added to\n\n\n      if (nextProps.graphic.needSupRefresh === true) {\n        this.featureLayer.refresh();\n      } // updates marker use nextProps or this.props for the map clicks?  if bugs come\n      // up , check this part\n\n\n      if (nextProps.graphic.mapClickMode === mapModes.SELECT_SUPPORT_MODE) {\n        this.selPoint.geometry = nextProps.graphic.selSupportGeom;\n        this.selPoint.symbol = this.symb;\n        this.markerLayer.removeAll();\n        this.markerLayer.add(this.selPoint); //   this.view.zoom = 20\n\n        this.view.center = this.selPoint.geometry;\n      } else if (this.props.graphic.mapClickMode === mapModes.ADD_SUPPORT_MODE) {\n        //gonna try to keep the selected point in local state\n        var addMark = {};\n        addMark.geometry = this.state.newSupportClickGeom;\n        addMark.symbol = this.addSymb;\n        this.markerLayer.removeAll();\n        this.markerLayer.add(addMark); //center, but no zoom\n\n        this.view.center = addMark.geometry;\n      } else {\n        this.markerLayer.removeAll();\n      }\n\n      this.view.surface.style.cursor = nextProps.graphic.cursor;\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(Container, {\n        ref: \"mapDiv\",\n        id: containerID,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 146\n        },\n        __self: this\n      });\n    } // ESRI JSAPI\n\n  }]);\n\n  return MapView;\n}(Component);\n\nvar mapStateToProps = function mapStateToProps(state) {\n  return {\n    config: state.config,\n    map: state.map,\n    graphic: state.graphic\n  };\n};\n\nvar mapDispatchToProps = function mapDispatchToProps(dispatch) {\n  return bindActionCreators(_objectSpread({}, mapActions, graphicActions), dispatch);\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(MapView);","map":{"version":3,"sources":["C:\\Projects\\Signworks3\\src\\components\\esri\\map\\MapView.js"],"names":["React","Component","connect","bindActionCreators","actions","mapActions","graphicActions","mapModes","loadModules","createView","styled","pointToExtent","Container","div","containerID","MapView","props","selPoint","markerLayer","queryMarkerLayer","featureLayer","symb","addSymb","geom","startup","mapConfig","node","isScene","then","response","init","setupWidgetsAndLayers","finishedLoading","error","console","window","setTimeout","onMapLoaded","view","extent","getSelectedSupport","expandedMapPoint","onMapClicked","config","featureURLs","mapClickHandler","evt","graphic","mapClickMode","SELECT_SUPPORT_MODE","setPointBuffer","width","spatialReference","mapPoint","ADD_SUPPORT_MODE","newSupportFeature","atrributes","geometry","x","longitude","y","latitude","type","log","setState","newSupportClickGeom","startStreetSmartViewer","viewWidth","viewExtentWidth","view_spatRef","mapMoveHandler","zoom","onMapChanged","map","FeatureLayer","GraphicsLayer","Graphic","TileLayer","Basemap","layerUrl","baselayer","baseMap","baseLayers","url","supports","definitionExpression","outFields","id","addMany","on","style","color","size","outline","symbol","state","is3DScene","nextProps","nextState","showQuery","removeAll","queryFeatures","length","graphics","querySymb","removeQueryResults","gr","i","add","needSupRefresh","refresh","selSupportGeom","center","addMark","surface","cursor","mapStateToProps","mapDispatchToProps","dispatch"],"mappings":"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","sourcesContent":["// Copyright 2019 Esri Licensed under the Apache License, Version 2.0 (the\r\n// \"License\"); you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n// http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law\r\n// or agreed to in writing, software distributed under the License is\r\n// distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n// KIND, either express or implied. See the License for the specific language\r\n// governing permissions and limitations under the License.​ NOTE This is a\r\n// \"special\" react component that does not strictly play by React's rules.\r\n//\r\n// Conceptually, this component creates a \"portal\" in React by closing its\r\n// render method off from updates (by simply rendering a div and never accepting\r\n// re-renders) then reconnecting itself to the React lifecycle by listening for\r\n// any new props (using componentWillReceiveProps) React\r\nimport React, {Component} from 'react';\r\n\r\n// Redux\r\nimport {connect} from 'react-redux';\r\nimport {bindActionCreators} from 'redux';\r\nimport {actions as mapActions} from '../../../redux/reducers/map';\r\nimport {actions as graphicActions} from '../../../redux/reducers/graphic'\r\nimport {mapModes} from '../../../redux/reducers/graphic'\r\n// ESRI\r\nimport {loadModules} from 'esri-loader';\r\nimport {createView} from '../../../utils/esriHelper';\r\n\r\n// Styled Components\r\nimport styled from 'styled-components';\r\n\r\nimport {pointToExtent} from '../../../utils/JSAPI';\r\n\r\nconst Container = styled.div `\r\n  height: 100%;\r\n  width: 100%;\r\n`;\r\n\r\n// Variables\r\nconst containerID = \"map-view-container\";\r\n\r\nclass MapView extends Component {\r\n    selPoint = null;\r\n    markerLayer = null;\r\n    queryMarkerLayer = null;\r\n    featureLayer = null;\r\n    symb = null;\r\n    addSymb = null;\r\n    geom = null;\r\n\r\n\r\n    constructor(props) {\r\n        super(props)\r\n        this.state = {newSupportClickGeom:null}\r\n        \r\n    }\r\n    componentDidMount() {\r\n\r\n        this.startup(this.props.mapConfig, containerID, this.props.is3DScene);\r\n    }\r\n\r\n    shouldComponentUpdate(nextProps, nextState) {\r\n        // Tell React to never update this component, that's up to us\r\n        return false;\r\n    }\r\n\r\n    UNSAFE_componentWillReceiveProps(nextProps) {\r\n        //removes superQuery results from view based on store\r\n        if (nextProps.graphic.showQuery === false) {\r\n            this.queryMarkerLayer.removeAll();\r\n        }\r\n        //if there are query features in the store, this block displays them in the view\r\n        if (nextProps.graphic.queryFeatures.length > 0) {\r\n            const graphics = [...nextProps.graphic.queryFeatures]\r\n            // add symbols\r\n            let querySymb = {\r\n                type: \"simple-marker\", // autocasts as new SimpleMarkerSymbol()  NEVER TRUST AUTOCAST\r\n                style: \"circle\",\r\n                color: [\r\n                    0, 255, 0, 0.0\r\n                ],\r\n                size: \"30px\", // pixels\r\n                outline: { // autocasts as new SimpleLineSymbol()\r\n                    color: 'blue',\r\n                    width: 3 // points\r\n                }\r\n            };\r\n\r\n            //this just sets query results in the store to empty array\r\n            this\r\n                .props\r\n                .removeQueryResults();\r\n            // create graphics and add them to layer\r\n            loadModules([\"esri/Graphic\"]).then(([Graphic]) => {\r\n                let gr = null;\r\n                for (let i = 0; i < graphics.length; i++) {\r\n                    graphics[i].geometry.type = \"point\"\r\n                    gr = new Graphic({geometry: graphics[i].geometry, symbol: querySymb})\r\n                    this\r\n                        .queryMarkerLayer\r\n                        .add(gr)\r\n                }\r\n\r\n            })\r\n\r\n        }\r\n       //let's see if the support layer has been added to\r\n\r\n       if(nextProps.graphic.needSupRefresh === true){\r\n           this.featureLayer.refresh();\r\n       }\r\n        // updates marker use nextProps or this.props for the map clicks?  if bugs come\r\n        // up , check this part\r\n        if (nextProps.graphic.mapClickMode === mapModes.SELECT_SUPPORT_MODE) {\r\n\r\n            this.selPoint.geometry = nextProps.graphic.selSupportGeom;\r\n            this.selPoint.symbol = this.symb;\r\n            this\r\n                .markerLayer\r\n                .removeAll();\r\n            this\r\n                .markerLayer\r\n                .add(this.selPoint)\r\n\r\n         //   this.view.zoom = 20\r\n \r\n            this.view.center = this.selPoint.geometry\r\n        } else if (this.props.graphic.mapClickMode === mapModes.ADD_SUPPORT_MODE) {\r\n            //gonna try to keep the selected point in local state\r\n            let addMark = {};\r\n            addMark.geometry = this.state.newSupportClickGeom;\r\n            addMark.symbol = this.addSymb;\r\n            this.markerLayer.removeAll();\r\n            this.markerLayer.add(addMark)\r\n            //center, but no zoom\r\n            this.view.center = addMark.geometry\r\n        }\r\n        else{\r\n            this.markerLayer.removeAll();\r\n        }\r\n\r\n        this.view.surface.style.cursor = nextProps.graphic.cursor;\r\n    }\r\n\r\n    render() {\r\n\r\n        return (\r\n            <Container ref=\"mapDiv\" id={containerID}></Container>\r\n        );\r\n    }\r\n\r\n    // ESRI JSAPI\r\n    startup = (mapConfig, node, isScene = false) => {\r\n        createView(mapConfig, node, isScene).then(response => {\r\n            this.init(response);\r\n\r\n            this.setupWidgetsAndLayers();\r\n            this.finishedLoading();\r\n\r\n        }, error => {\r\n            console.error(\"maperr\", error);\r\n            window.setTimeout(() => {\r\n                this.startup(mapConfig, node);\r\n            }, 1000);\r\n        })\r\n    }\r\n\r\n    finishedLoading = () => {\r\n        // Update app state only after map and widgets are loaded\r\n        this\r\n            .props\r\n            .onMapLoaded(this.view.extent);\r\n    }\r\n\r\n    getSelectedSupport = (expandedMapPoint) => {\r\n        // this line takes the buffered point and sends it  to the map reducer which\r\n        // punts it to the _setSupport saga which queries and gets the support, signs,\r\n        // timebands, etc and writes them to the store, where they dictate the Rightbar\r\n        // display.  Once the store changes the action picks up in willReceiveProps\r\n\r\n        this\r\n            .props\r\n            .onMapClicked(expandedMapPoint, this.props.config.featureURLs);\r\n\r\n    }\r\n\r\n    mapClickHandler = (evt) => {\r\n\r\n        // in any map app that's more than a viewer, the map click event is gonna be\r\n        // complicated so much so that I wrote this a month ago and it is already\r\n        // getting away from me so we shall comment.  The click event is first captured\r\n        // here then evaluated against the store to decide what it is supposed to do\r\n        switch (this.props.graphic.mapClickMode) {\r\n                //the click is supposed to select an existing support on the map\r\n            case mapModes.SELECT_SUPPORT_MODE:\r\n\r\n                // this redux call moves info about the view into the store so that an extent\r\n                // around the point can be calculated I don't think it changes, (todo) see about\r\n                // moving it to map load or something\r\n                this\r\n                    .props\r\n                    .setPointBuffer(this.view.width, this.view.extent.width, this.view.spatialReference);\r\n                // this creates a small extent buffer around the mapPoint to aid in the select\r\n                // query its callback is getSelectedSupport, above\r\n                pointToExtent(this.view.width, this.view.extent.width, this.view.spatialReference, evt.mapPoint, 12, this.getSelectedSupport);\r\n                break;\r\n                //ok now we are in add support mode\r\n            case mapModes.ADD_SUPPORT_MODE:\r\n                // we should create a 'fake' feature out of the map click event\r\n\r\n                const newSupportFeature = {\r\n                    atrributes: {},\r\n                    geometry: {\r\n                        x: evt.mapPoint.longitude,\r\n                        y: evt.mapPoint.latitude,\r\n                        type: 'point'\r\n                    }\r\n                }\r\n                //grabbing a local copy of the mapPoint.geom for the marker\r\n       console.log('evt.mapPoint', evt.mapPoint)\r\n                this.setState({newSupportClickGeom:evt.mapPoint})\r\n                this\r\n                    .props\r\n                    .startStreetSmartViewer([newSupportFeature], this.props.config.featureURLs,\r\n                         4326, 2248, this.props.graphic.viewWidth, this.props.graphic.viewExtentWidth,\r\n                          this.props.graphic.view_spatRef, true);\r\n\r\n                break;\r\n            default:\r\n                return\r\n\r\n        }\r\n\r\n    }\r\n\r\n    mapMoveHandler = (evt) => {\r\n  console.log('this.view.zoom', this.view.zoom)\r\n        this\r\n            .props\r\n            .onMapChanged(this.view.extent);\r\n    }\r\n\r\n    init = (response) => {\r\n        this.view = response.view\r\n        this.map = response.view.map;\r\n        console.log('this.view.zoom on init :', this.view.zoom);\r\n    }\r\n\r\n    setupWidgetsAndLayers = () => {\r\n        loadModules(['esri/layers/FeatureLayer', \"esri/layers/GraphicsLayer\", 'esri/Graphic', \"esri/layers/TileLayer\", \"esri/Basemap\"]).then(([FeatureLayer, GraphicsLayer, Graphic, TileLayer, Basemap]) => {\r\n            const layerUrl = \"https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/DC_Basemap_LightGray_W\" +\r\n                    \"ebMercator/MapServer\";\r\n            const baselayer = new TileLayer(layerUrl, null);\r\n            const baseMap = new Basemap({baseLayers: [baselayer]})\r\n\r\n             this.featureLayer = new FeatureLayer({url: this.props.config.featureURLs.supports, definitionExpression: \"SUPPORTSTATUS = 1\", outFields: [\"*\"], id: \"support\"});\r\n            this.queryMarkerLayer = new GraphicsLayer();\r\n            this.markerLayer = new GraphicsLayer();\r\n\r\n       //     this.map.basemap = baseMap;\r\n            this\r\n                .map\r\n                .addMany([this.featureLayer, this.queryMarkerLayer, this.markerLayer]);\r\n            this\r\n                .view\r\n                .on(\"click\", this.mapClickHandler);\r\n\r\n            this\r\n                .view\r\n                .on(\"pointer-up\", this.mapMoveHandler);\r\n            this\r\n                .view\r\n                .on('mouse-wheel', this.mapMoveHandler)\r\n\r\n    \r\n\r\n            this.symb = {\r\n                type: \"simple-marker\", // autocasts as new SimpleMarkerSymbol()\r\n                style: \"circle\",\r\n                color: [\r\n                    0, 255, 0, 0.0\r\n                ],\r\n                size: \"30px\", // pixels\r\n                outline: { // autocasts as new SimpleLineSymbol()\r\n                    color: 'magenta',\r\n                    width: 3 // points\r\n                }\r\n            };\r\n            this.addSymb = {\r\n                type: \"simple-marker\", // autocasts as new SimpleMarkerSymbol()\r\n                style: \"circle\",\r\n                color: [\r\n                    0, 255, 0, 0.0\r\n                ],\r\n                size: \"30px\", // pixels\r\n                outline: { // autocasts as new SimpleLineSymbol()\r\n                    color: 'green',\r\n                    width: 3 // points\r\n                }\r\n            };\r\n\r\n            this.selPoint = new Graphic({geometry: null, symbol: this.symb})\r\n\r\n            //   this.markerLayer.add(this.selPoint)\r\n        });\r\n    }\r\n\r\n}\r\n\r\nconst mapStateToProps = state => ({config: state.config, map: state.map, graphic: state.graphic});\r\n\r\nconst mapDispatchToProps = function (dispatch) {\r\n    return bindActionCreators({\r\n        ...mapActions,\r\n        ...graphicActions\r\n    }, dispatch);\r\n}\r\n\r\nexport default connect(mapStateToProps, mapDispatchToProps)(MapView);\r\n"]},"metadata":{},"sourceType":"module"}