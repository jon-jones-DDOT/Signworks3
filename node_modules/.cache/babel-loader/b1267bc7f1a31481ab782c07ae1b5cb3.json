{"ast":null,"code":"import _objectSpread from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread\";\nimport _toConsumableArray from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/toConsumableArray\";\nimport _slicedToArray from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";\nimport _classCallCheck from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";\nimport _taggedTemplateLiteral from \"C:\\\\Projects\\\\Signworks3\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/taggedTemplateLiteral\";\nvar _jsxFileName = \"C:\\\\Projects\\\\Signworks3\\\\src\\\\components\\\\esri\\\\map\\\\MapView.js\";\n\nfunction _templateObject() {\n  var data = _taggedTemplateLiteral([\"\\n  height: 100%;\\n  width: 100%;\\n\"]);\n\n  _templateObject = function _templateObject() {\n    return data;\n  };\n\n  return data;\n}\n\n// Copyright 2019 Esri Licensed under the Apache License, Version 2.0 (the\n// \"License\"); you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n// http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law\n// or agreed to in writing, software distributed under the License is\n// distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n// KIND, either express or implied. See the License for the specific language\n// governing permissions and limitations under the License.​ NOTE This is a\n// \"special\" react component that does not strictly play by React's rules.\n//\n// Conceptually, this component creates a \"portal\" in React by closing its\n// render method off from updates (by simply rendering a div and never accepting\n// re-renders) then reconnecting itself to the React lifecycle by listening for\n// any new props (using componentWillReceiveProps) React\nimport React, { Component } from 'react'; // Redux\n\nimport { connect } from 'react-redux';\nimport { bindActionCreators } from 'redux';\nimport { actions as mapActions } from '../../../redux/reducers/map';\nimport { actions as graphicActions } from '../../../redux/reducers/graphic';\nimport { mapModes } from '../../../redux/reducers/graphic';\nimport { leftKeys } from '../../../SignworksJSON'; // ESRI\n\nimport { loadModules } from 'esri-loader';\nimport { createView } from '../../../utils/esriHelper';\nimport cloneDeep from 'lodash.clonedeep'; // Styled Components\n\nimport styled from 'styled-components';\nimport { pointToExtent, layerURLs } from '../../../utils/JSAPI';\nvar Container = styled.div(_templateObject()); // Variables\n\nvar containerID = \"map-view-container\";\n\nvar MapView =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(MapView, _Component);\n\n  function MapView(props) {\n    var _this;\n\n    _classCallCheck(this, MapView);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(MapView).call(this, props));\n    _this.selPoint = {\n      geometry: null\n    };\n    _this.markerLayer = null;\n    _this.queryMarkerLayer = null;\n    _this.featureLayer = null;\n    _this.conicLayer = null;\n    _this.drawExtentLayer = null;\n    _this.symb = null;\n    _this.addSymb = null;\n    _this.marSymb = null;\n    _this.geom = null;\n\n    _this.startup = function (mapConfig, node) {\n      var isScene = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n      createView(mapConfig, node, isScene).then(function (response) {\n        _this.init(response);\n\n        _this.setupWidgetsAndLayers();\n\n        _this.finishedLoading();\n      }, function (error) {\n        console.error(\"maperr\", error);\n        window.setTimeout(function () {\n          _this.startup(mapConfig, node);\n        }, 1000);\n      });\n    };\n\n    _this.finishedLoading = function () {\n      // Update app state only after map and widgets are loaded\n      _this.props.onMapLoaded(_this.view.extent);\n    };\n\n    _this.getSelectedSupport = function (expandedMapPoint) {\n      // this line takes the buffered point and sends it  to the map reducer which\n      // punts it to the _setSupport saga which queries and gets the support, signs,\n      // timebands, etc and writes them to the store, where they dictate the Rightbar\n      // display.  Once the store changes the action picks up in willReceiveProps\n      _this.props.onMapClicked(expandedMapPoint, layerURLs(_this.props));\n    };\n\n    _this.mapClickHandler = function (evt) {\n      // this redux call moves info about the view into the store so that an extent\n      // around the point can be calculated I don't think it changes, (todo) see about\n      // moving it to map load or something\n      _this.props.setPointBuffer(_this.view.width, _this.view.extent.width, _this.view.spatialReference); // in any map app that's more than a viewer, the map click event is gonna be\n      // complicated so much so that I wrote this a month ago and it is already\n      // getting away from me so we shall comment.  The click event is first captured\n      // here then evaluated against the store to decide what it is supposed to do\n\n\n      switch (_this.props.graphic.mapClickMode) {\n        //the click is supposed to select an existing support on the map\n        case mapModes.SELECT_SUPPORT_MODE:\n          // this creates a small extent buffer around the mapPoint to aid in the select\n          // query its callback is getSelectedSupport, above\n          pointToExtent(_this.view.width, _this.view.extent.width, _this.view.spatialReference, evt.mapPoint, 12, _this.getSelectedSupport);\n          break;\n        //ok now we are in add support mode\n\n        case mapModes.ADD_SUPPORT_MODE:\n          // we should create a 'fake' feature out of the map click event console.lg('map\n          // // click happens here')\n          var newSupportFeature = {\n            atrributes: {},\n            geometry: {\n              x: evt.mapPoint.longitude,\n              y: evt.mapPoint.latitude,\n              type: 'point'\n            } //grabbing a local copy of the mapPoint.geom for the marker\n\n          };\n\n          _this.setState({\n            newSupportClickGeom: evt.mapPoint\n          });\n\n          _this.props.startStreetSmartViewer([newSupportFeature], layerURLs(_this.props), 4326, 2248, _this.props.graphic.viewWidth, _this.props.graphic.viewExtentWidth, _this.props.graphic.view_spatRef, true);\n\n          _this.props.setMapClickMode(mapModes.SELECT_SUPPORT_MODE, 'default');\n\n          _this.view.surface.style.cursor = \"default\";\n          break;\n\n        case mapModes.DRAW_MODE:\n          var draw, action;\n          loadModules(['esri/views/draw/Draw', \"esri/Graphic\"]).then(function (_ref) {\n            var _ref2 = _slicedToArray(_ref, 2),\n                Draw = _ref2[0],\n                Graphic = _ref2[1];\n\n            function createPolygonGraphic(layer, vertices) {\n              layer.removeAll();\n              var polygon = {\n                type: \"polygon\",\n                // autocasts as Polygon\n                rings: vertices,\n                spatialReference: this.view.spatialReference\n              };\n              var graphic = new Graphic({\n                geometry: polygon,\n                symbol: {\n                  type: \"simple-fill\",\n                  // autocasts as SimpleFillSymbol\n                  color: \"purple\",\n                  style: \"solid\",\n                  outline: {\n                    // autocasts as SimpleLineSymbol\n                    color: \"white\",\n                    width: 1\n                  }\n                }\n              });\n              layer.add(graphic);\n            }\n\n            draw = new Draw({\n              view: _this.view\n            });\n            action = draw.create(\"polygon\"); // PolygonDrawAction.vertex-add Fires when user clicks, or presses the \"F\" key.\n            // Can also be triggered when the \"R\" key is pressed to redo.\n\n            action.on(\"vertex-add\", function (evt) {\n              createPolygonGraphic(this.drawExtentLayer, evt.vertices);\n            }); // PolygonDrawAction.vertex-remove Fires when the \"Z\" key is pressed to undo the\n            // last added vertex\n\n            action.on(\"vertex-remove\", function (evt) {\n              createPolygonGraphic(this.drawExtentLayer, evt.vertices);\n            }); // Fires when the pointer moves over the view\n\n            action.on(\"cursor-update\", function (evt) {\n              createPolygonGraphic(this.drawExtentLayer, evt.vertices);\n            }); // Add a graphic representing the completed polygon when user double-clicks on\n            // the view or presses the \"C\" key\n\n            action.on(\"draw-complete\", function (evt) {\n              createPolygonGraphic(this.drawExtentLayer, evt.vertices);\n            });\n          });\n          break;\n\n        default:\n          return;\n      }\n    };\n\n    _this.mapMoveHandler = function (evt) {\n      _this.props.onMapChanged(_this.view.extent);\n    };\n\n    _this.init = function (response) {\n      _this.view = response.view;\n      _this.map = response.view.map;\n    };\n\n    _this.setupWidgetsAndLayers = function () {\n      loadModules(['esri/layers/FeatureLayer', \"esri/layers/GraphicsLayer\", 'esri/Graphic']).then(function (_ref3) {\n        var _ref4 = _slicedToArray(_ref3, 3),\n            FeatureLayer = _ref4[0],\n            GraphicsLayer = _ref4[1],\n            Graphic = _ref4[2];\n\n        _this.featureLayer = new FeatureLayer({\n          url: layerURLs(_this.props).supports,\n          definitionExpression: \"SUPPORTSTATUS = 1\",\n          outFields: [\"*\"],\n          id: \"support\"\n        });\n        _this.queryMarkerLayer = new GraphicsLayer();\n        _this.markerLayer = new GraphicsLayer();\n        _this.conicLayer = new GraphicsLayer();\n        _this.drawExtentLayer = new GraphicsLayer(); //     this.map.basemap = baseMap;\n\n        _this.map.addMany([_this.featureLayer, _this.queryMarkerLayer, _this.markerLayer, _this.conicLayer, _this.drawExtentLayer]);\n\n        _this.view.on(\"click\", _this.mapClickHandler);\n\n        _this.view.on(\"pointer-up\", _this.mapMoveHandler);\n\n        _this.view.on('mouse-wheel', _this.mapMoveHandler);\n\n        _this.symb = {\n          type: \"simple-marker\",\n          // autocasts as new SimpleMarkerSymbol()\n          style: \"circle\",\n          color: [0, 255, 0, 0.0],\n          size: \"30px\",\n          // pixels\n          outline: {\n            // autocasts as new SimpleLineSymbol()\n            color: 'magenta',\n            width: 3 // points\n\n          }\n        };\n        _this.addSymb = {\n          type: \"simple-marker\",\n          // autocasts as new SimpleMarkerSymbol()\n          style: \"circle\",\n          color: [0, 255, 0, 0.0],\n          size: \"30px\",\n          // pixels\n          outline: {\n            // autocasts as new SimpleLineSymbol()\n            color: 'green',\n            width: 3 // points\n\n          }\n        };\n        _this.marSymb = {\n          type: \"simple-marker\",\n          // autocasts as new SimpleMarkerSymbol()\n          style: \"square\",\n          color: [0, 255, 0, 0.0],\n          size: \"30px\",\n          // pixels\n          outline: {\n            // autocasts as new SimpleLineSymbol()\n            color: 'green',\n            width: 3 // points\n\n          }\n        };\n        _this.selPoint = new Graphic({\n          geometry: null,\n          symbol: _this.symb\n        }); //   this.markerLayer.add(this.selPoint)\n      });\n    };\n\n    _this.state = {\n      newSupportClickGeom: null\n    };\n    return _this;\n  }\n\n  _createClass(MapView, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.startup(this.props.mapConfig, containerID, this.props.is3DScene);\n    }\n  }, {\n    key: \"shouldComponentUpdate\",\n    value: function shouldComponentUpdate(nextProps, nextState) {\n      //view cone needs adjustment\n      if (this.props.graphic.coneGraphic !== nextProps.graphic.coneGraphic) {\n        //    console.lg('update due to view cone');\n        return true;\n      }\n\n      if (nextState.newSupportClickGeom !== this.state.newSupportClickGeom) {\n        //        console.lg('update because map clicked to select target area for new\n        // support')\n        return true;\n      }\n\n      if (this.props.graphic.queryFeatures.length > 0 && this.props.graphic.queryFeatures !== nextProps.graphic.queryFeatures) {\n        //        console.lg('update because of query features');\n        return true;\n      }\n\n      if (this.props.graphic.needSupRefresh === true) {\n        //       console.lg('update to refresh for new support feature added');\n        return true;\n      }\n\n      if (this.props.graphic.mapClickMode !== nextProps.graphic.mapClickMode) {\n        //        console.lg('update because mapClickMode changed.  Not sure this does\n        // anything')\n        return true;\n      }\n\n      if (this.props.map.support !== nextProps.map.support) {\n        //         console.lg('update because map.support changed');\n        return true;\n      } //removes superQuery results from view based on store\n\n\n      if (nextProps.graphic.showQuery !== this.props.graphic.showQuery) {\n        //          console.lg('update because showQuery has changed');\n        return true;\n      }\n\n      if (nextProps.graphic.ssOverlay === null & this.conicLayer.graphics.length > 0) {\n        //     console.lg('update because view cone needs to be removed');\n        return true;\n      }\n\n      if (nextProps.graphic.zoomPoint != this.props.graphic.zoomPoint) {\n        return true;\n      }\n\n      if (nextProps.map.retiredPosts != this.props.map.retiredPosts) {\n        return true;\n      } //    console.lg('did not update');\n\n\n      return false;\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps, prevState, snapshot) {\n      var _this2 = this;\n\n      // changes cone graphic in response to evt\n      if (this.props.graphic.coneGraphic !== prevProps.graphic.coneGraphic) {\n        this.conicLayer.removeAll(); //   console.lg('unexpected call to cone graphics');\n\n        this.queryMarkerLayer.removeAll();\n        this.conicLayer.add(this.props.graphic.coneGraphic);\n        this.conicLayer.add(this.props.graphic.conePointGraphic);\n        return;\n      } // removes all query graphics\n\n\n      if (this.props.graphic.showQuery === false && this.queryMarkerLayer.graphics.length > 0) {\n        //      console.lg('removing query markers')\n        this.queryMarkerLayer.removeAll();\n      } //removes cone graphics\n\n\n      if (this.props.graphic.ssOverlay === null && this.conicLayer.graphics.length > 0) {\n        //      console.lg('removing conic graphics')\n        this.conicLayer.removeAll();\n      } //if there are query features in the store, this block displays them in the view\n\n\n      if (this.props.graphic.queryFeatures.length > 0) {\n        //       console.lg('adding query features');\n        var graphics = _toConsumableArray(this.props.graphic.queryFeatures); // add symbols\n\n\n        var querySymb = {\n          type: \"simple-marker\",\n          // autocasts as new SimpleMarkerSymbol()  NEVER TRUST AUTOCAST\n          style: \"circle\",\n          color: [0, 255, 0, 0.0],\n          size: \"35px\",\n          // pixels\n          outline: {\n            // autocasts as new SimpleLineSymbol()\n            color: 'blue',\n            width: 3 // points\n\n          }\n        }; //this just sets query results in the store to empty array\n\n        this.props.removeQueryResults(); // create graphics and add them to layer\n\n        loadModules([\"esri/Graphic\"]).then(function (_ref5) {\n          var _ref6 = _slicedToArray(_ref5, 1),\n              Graphic = _ref6[0];\n\n          var gr = null;\n\n          for (var i = 0; i < graphics.length; i++) {\n            graphics[i].geometry.type = \"point\";\n            gr = new Graphic({\n              geometry: graphics[i].geometry,\n              symbol: querySymb\n            });\n\n            _this2.queryMarkerLayer.add(gr);\n          }\n        });\n      } //let's see if the support layer has been added to\n\n\n      if (this.props.graphic.needSupRefresh === true) {\n        //       console.lg('refershing support layer on map after add')\n        this.featureLayer.refresh();\n      } // updates marker use nextProps or this.props for the map clicks?  if bugs come\n      // up , check this part\n\n\n      if (this.props.graphic.mapClickMode === mapModes.SELECT_SUPPORT_MODE && !this.props.graphic.selSupportGeom) {} //  console.lg('not even sure why')   return;\n      //changes map graphics when new support is selected\n\n\n      if (this.props.graphic.mapClickMode === mapModes.SELECT_SUPPORT_MODE && this.props.map.support !== prevProps.map.support) {\n        this.selPoint.geometry = this.props.graphic.selSupportGeom;\n\n        if (this.props.graphic.leftKey === 1 || this.props.graphic.leftKey === leftKeys.SS_VIEW_REPEAT) {\n          this.props.startStreetSmartViewer([this.selPoint], layerURLs(this.props), 4326, 2248, this.props.graphic.viewWidth, this.props.graphic.viewExtentWidth, this.props.graphic.view_spatRef, false, leftKeys.SS_VIEW_FIRST, this.props.map.retiredPosts);\n        }\n\n        this.selPoint.symbol = this.symb;\n        this.markerLayer.removeAll();\n        this.markerLayer.add(this.selPoint);\n        this.view.zoom = 20;\n        this.view.center = this.selPoint.geometry;\n      } else if (this.props.graphic.mapClickMode === mapModes.ADD_SUPPORT_MODE && prevState.newSupportClickGeom !== this.state.newSupportClickGeom) {\n        // gonna try to keep the selected point in local state console.lg('changing add\n        // support target graphic because of click')\n        var addMark = {};\n        addMark.geometry = this.state.newSupportClickGeom;\n        this.view.center = addMark.geometry;\n        this.view.zoom = 19;\n      }\n\n      if (this.props.graphic.zoomPoint != prevProps.graphic.zoomPoint) {\n        var marPoint = {};\n        marPoint.geometry = cloneDeep(this.props.graphic.zoomPoint);\n        marPoint.symbol = this.marSymb;\n        this.queryMarkerLayer.removeAll();\n        this.queryMarkerLayer.addMany([marPoint]);\n        this.view.center = marPoint.geometry;\n        this.view.zoom = 19;\n      }\n\n      if (this.props.map.retiredPosts != prevProps.map.retiredPosts) {\n        if (this.props.map.retiredPosts === 2) {\n          this.featureLayer.definitionExpression = ' SUPPORTSTATUS = 5';\n        } else if (this.props.map.retiredPosts === 1) {\n          this.featureLayer.definitionExpression = 'SUPPORTSTATUS = 1 OR SUPPORTSTATUS = 5';\n        } else if (this.props.map.retiredPosts === 3) {\n          this.featureLayer.definitionExpression = 'SUPPORTSTATUS = 627';\n        } else {\n          this.featureLayer.definitionExpression = \"SUPPORTSTATUS = 1\";\n        }\n      }\n\n      this.view.surface.style.cursor = this.props.graphic.cursor;\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(Container, {\n        ref: \"mapDiv\",\n        id: containerID,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 276\n        },\n        __self: this\n      });\n    } // ESRI JSAPI\n\n  }]);\n\n  return MapView;\n}(Component);\n\nvar mapStateToProps = function mapStateToProps(state) {\n  return {\n    config: state.config,\n    auth: state.auth,\n    map: state.map,\n    graphic: state.graphic\n  };\n};\n\nvar mapDispatchToProps = function mapDispatchToProps(dispatch) {\n  return bindActionCreators(_objectSpread({}, mapActions, graphicActions), dispatch);\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(MapView);","map":{"version":3,"sources":["C:\\Projects\\Signworks3\\src\\components\\esri\\map\\MapView.js"],"names":["React","Component","connect","bindActionCreators","actions","mapActions","graphicActions","mapModes","leftKeys","loadModules","createView","cloneDeep","styled","pointToExtent","layerURLs","Container","div","containerID","MapView","props","selPoint","geometry","markerLayer","queryMarkerLayer","featureLayer","conicLayer","drawExtentLayer","symb","addSymb","marSymb","geom","startup","mapConfig","node","isScene","then","response","init","setupWidgetsAndLayers","finishedLoading","error","console","window","setTimeout","onMapLoaded","view","extent","getSelectedSupport","expandedMapPoint","onMapClicked","mapClickHandler","evt","setPointBuffer","width","spatialReference","graphic","mapClickMode","SELECT_SUPPORT_MODE","mapPoint","ADD_SUPPORT_MODE","newSupportFeature","atrributes","x","longitude","y","latitude","type","setState","newSupportClickGeom","startStreetSmartViewer","viewWidth","viewExtentWidth","view_spatRef","setMapClickMode","surface","style","cursor","DRAW_MODE","draw","action","Draw","Graphic","createPolygonGraphic","layer","vertices","removeAll","polygon","rings","symbol","color","outline","add","create","on","mapMoveHandler","onMapChanged","map","FeatureLayer","GraphicsLayer","url","supports","definitionExpression","outFields","id","addMany","size","state","is3DScene","nextProps","nextState","coneGraphic","queryFeatures","length","needSupRefresh","support","showQuery","ssOverlay","graphics","zoomPoint","retiredPosts","prevProps","prevState","snapshot","conePointGraphic","querySymb","removeQueryResults","gr","i","refresh","selSupportGeom","leftKey","SS_VIEW_REPEAT","SS_VIEW_FIRST","zoom","center","addMark","marPoint","mapStateToProps","config","auth","mapDispatchToProps","dispatch"],"mappings":"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","sourcesContent":["// Copyright 2019 Esri Licensed under the Apache License, Version 2.0 (the\r\n// \"License\"); you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n// http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law\r\n// or agreed to in writing, software distributed under the License is\r\n// distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n// KIND, either express or implied. See the License for the specific language\r\n// governing permissions and limitations under the License.​ NOTE This is a\r\n// \"special\" react component that does not strictly play by React's rules.\r\n//\r\n// Conceptually, this component creates a \"portal\" in React by closing its\r\n// render method off from updates (by simply rendering a div and never accepting\r\n// re-renders) then reconnecting itself to the React lifecycle by listening for\r\n// any new props (using componentWillReceiveProps) React\r\nimport React, {Component} from 'react';\r\n\r\n// Redux\r\nimport {connect} from 'react-redux';\r\nimport {bindActionCreators} from 'redux';\r\nimport {actions as mapActions} from '../../../redux/reducers/map';\r\nimport {actions as graphicActions} from '../../../redux/reducers/graphic'\r\nimport {mapModes} from '../../../redux/reducers/graphic'\r\nimport {leftKeys} from '../../../SignworksJSON'\r\n// ESRI\r\nimport {loadModules} from 'esri-loader';\r\nimport {createView} from '../../../utils/esriHelper';\r\nimport cloneDeep from 'lodash.clonedeep';\r\n// Styled Components\r\nimport styled from 'styled-components';\r\n\r\nimport {pointToExtent, layerURLs} from '../../../utils/JSAPI';\r\n\r\nconst Container = styled.div `\r\n  height: 100%;\r\n  width: 100%;\r\n`;\r\n\r\n// Variables\r\nconst containerID = \"map-view-container\";\r\n\r\nclass MapView extends Component {\r\n    selPoint = {\r\n        geometry: null\r\n    };\r\n    markerLayer = null;\r\n    queryMarkerLayer = null;\r\n    featureLayer = null;\r\n    conicLayer = null;\r\n    drawExtentLayer = null;\r\n    symb = null;\r\n    addSymb = null;\r\n    marSymb = null;\r\n    geom = null;\r\n\r\n    constructor(props) {\r\n        super(props)\r\n        this.state = {\r\n            newSupportClickGeom: null\r\n        }\r\n\r\n    }\r\n    componentDidMount() {\r\n\r\n        this.startup(this.props.mapConfig, containerID, this.props.is3DScene);\r\n    }\r\n\r\n    shouldComponentUpdate(nextProps, nextState) {\r\n\r\n        //view cone needs adjustment\r\n        if (this.props.graphic.coneGraphic !== nextProps.graphic.coneGraphic) {\r\n            //    console.lg('update due to view cone');\r\n            return true;\r\n        }\r\n        if (nextState.newSupportClickGeom !== this.state.newSupportClickGeom) {\r\n            //        console.lg('update because map clicked to select target area for new\r\n            // support')\r\n            return true;\r\n        }\r\n\r\n        if (this.props.graphic.queryFeatures.length > 0 && this.props.graphic.queryFeatures !== nextProps.graphic.queryFeatures) {\r\n            //        console.lg('update because of query features');\r\n            return true;\r\n        }\r\n        if (this.props.graphic.needSupRefresh === true) {\r\n            //       console.lg('update to refresh for new support feature added');\r\n            return true;\r\n        }\r\n\r\n        if (this.props.graphic.mapClickMode !== nextProps.graphic.mapClickMode) {\r\n            //        console.lg('update because mapClickMode changed.  Not sure this does\r\n            // anything')\r\n            return true;\r\n        }\r\n\r\n        if (this.props.map.support !== nextProps.map.support) {\r\n            //         console.lg('update because map.support changed');\r\n            return true\r\n        }\r\n        //removes superQuery results from view based on store\r\n        if (nextProps.graphic.showQuery !== this.props.graphic.showQuery) {\r\n            //          console.lg('update because showQuery has changed');\r\n            return true;\r\n        }\r\n\r\n        if (nextProps.graphic.ssOverlay === null & this.conicLayer.graphics.length > 0) {\r\n            //     console.lg('update because view cone needs to be removed');\r\n            return true;\r\n        }\r\n\r\n        if (nextProps.graphic.zoomPoint != this.props.graphic.zoomPoint) {\r\n\r\n            return true;\r\n        }\r\n        if (nextProps.map.retiredPosts != this.props.map.retiredPosts) {\r\n            return true;\r\n        }\r\n        //    console.lg('did not update');\r\n        return false;\r\n    }\r\n\r\n    componentDidUpdate(prevProps, prevState, snapshot) {\r\n\r\n        // changes cone graphic in response to evt\r\n        if (this.props.graphic.coneGraphic !== prevProps.graphic.coneGraphic) {\r\n\r\n            this\r\n                .conicLayer\r\n                .removeAll();\r\n\r\n            //   console.lg('unexpected call to cone graphics');\r\n            this\r\n                .queryMarkerLayer\r\n                .removeAll();\r\n            this\r\n                .conicLayer\r\n                .add(this.props.graphic.coneGraphic)\r\n            this\r\n                .conicLayer\r\n                .add(this.props.graphic.conePointGraphic)\r\n            return;\r\n        }\r\n        // removes all query graphics\r\n        if (this.props.graphic.showQuery === false && this.queryMarkerLayer.graphics.length > 0) {\r\n            //      console.lg('removing query markers')\r\n            this\r\n                .queryMarkerLayer\r\n                .removeAll();\r\n        }\r\n        //removes cone graphics\r\n        if (this.props.graphic.ssOverlay === null && this.conicLayer.graphics.length > 0) {\r\n            //      console.lg('removing conic graphics')\r\n            this\r\n                .conicLayer\r\n                .removeAll();\r\n        }\r\n\r\n        //if there are query features in the store, this block displays them in the view\r\n        if (this.props.graphic.queryFeatures.length > 0) {\r\n            //       console.lg('adding query features');\r\n            const graphics = [...this.props.graphic.queryFeatures]\r\n            // add symbols\r\n            let querySymb = {\r\n                type: \"simple-marker\", // autocasts as new SimpleMarkerSymbol()  NEVER TRUST AUTOCAST\r\n                style: \"circle\",\r\n                color: [\r\n                    0, 255, 0, 0.0\r\n                ],\r\n                size: \"35px\", // pixels\r\n                outline: { // autocasts as new SimpleLineSymbol()\r\n                    color: 'blue',\r\n                    width: 3 // points\r\n                }\r\n            };\r\n\r\n            //this just sets query results in the store to empty array\r\n            this\r\n                .props\r\n                .removeQueryResults();\r\n            // create graphics and add them to layer\r\n            loadModules([\"esri/Graphic\"]).then(([Graphic]) => {\r\n                let gr = null;\r\n                for (let i = 0; i < graphics.length; i++) {\r\n                    graphics[i].geometry.type = \"point\"\r\n                    gr = new Graphic({geometry: graphics[i].geometry, symbol: querySymb})\r\n\r\n                    this\r\n                        .queryMarkerLayer\r\n                        .add(gr)\r\n                }\r\n\r\n            })\r\n\r\n        }\r\n\r\n        //let's see if the support layer has been added to\r\n\r\n        if (this.props.graphic.needSupRefresh === true) {\r\n            //       console.lg('refershing support layer on map after add')\r\n            this\r\n                .featureLayer\r\n                .refresh();\r\n        }\r\n\r\n        // updates marker use nextProps or this.props for the map clicks?  if bugs come\r\n        // up , check this part\r\n        if (this.props.graphic.mapClickMode === mapModes.SELECT_SUPPORT_MODE && !this.props.graphic.selSupportGeom) {\r\n            //  console.lg('not even sure why')   return;\r\n        }\r\n        //changes map graphics when new support is selected\r\n        if (this.props.graphic.mapClickMode === mapModes.SELECT_SUPPORT_MODE && this.props.map.support !== prevProps.map.support) {\r\n\r\n            this.selPoint.geometry = this.props.graphic.selSupportGeom;\r\n            if (this.props.graphic.leftKey === 1 || this.props.graphic.leftKey === leftKeys.SS_VIEW_REPEAT) {\r\n\r\n                this\r\n                    .props\r\n                    .startStreetSmartViewer([this.selPoint], layerURLs(this.props), 4326, 2248, this.props.graphic.viewWidth, this.props.graphic.viewExtentWidth, this.props.graphic.view_spatRef, false, leftKeys.SS_VIEW_FIRST, this.props.map.retiredPosts)\r\n            }\r\n\r\n            this.selPoint.symbol = this.symb;\r\n            this\r\n                .markerLayer\r\n                .removeAll();\r\n            this\r\n                .markerLayer\r\n                .add(this.selPoint)\r\n\r\n            this.view.zoom = 20\r\n\r\n            this.view.center = this.selPoint.geometry\r\n        } else if (this.props.graphic.mapClickMode === mapModes.ADD_SUPPORT_MODE && prevState.newSupportClickGeom !== this.state.newSupportClickGeom) {\r\n            // gonna try to keep the selected point in local state console.lg('changing add\r\n            // support target graphic because of click')\r\n            let addMark = {};\r\n            addMark.geometry = this.state.newSupportClickGeom;\r\n\r\n            this.view.center = addMark.geometry;\r\n            this.view.zoom = 19;\r\n        }\r\n\r\n        if (this.props.graphic.zoomPoint != prevProps.graphic.zoomPoint) {\r\n            let marPoint = {};\r\n            marPoint.geometry = cloneDeep(this.props.graphic.zoomPoint);\r\n\r\n            marPoint.symbol = this.marSymb;\r\n\r\n            this\r\n                .queryMarkerLayer\r\n                .removeAll();\r\n            this\r\n                .queryMarkerLayer\r\n                .addMany([marPoint]);\r\n            this.view.center = marPoint.geometry;\r\n            this.view.zoom = 19;\r\n\r\n        }\r\n        if (this.props.map.retiredPosts != prevProps.map.retiredPosts) {\r\n\r\n            if (this.props.map.retiredPosts === 2) {\r\n                this.featureLayer.definitionExpression = ' SUPPORTSTATUS = 5'\r\n            } else if (this.props.map.retiredPosts === 1) {\r\n                this.featureLayer.definitionExpression = 'SUPPORTSTATUS = 1 OR SUPPORTSTATUS = 5'\r\n            } else if (this.props.map.retiredPosts === 3) {\r\n                this.featureLayer.definitionExpression = 'SUPPORTSTATUS = 627'\r\n            } else {\r\n                this.featureLayer.definitionExpression = \"SUPPORTSTATUS = 1\"\r\n            }\r\n        }\r\n\r\n        this.view.surface.style.cursor = this.props.graphic.cursor;\r\n    }\r\n\r\n    render() {\r\n\r\n        return (\r\n            <Container ref=\"mapDiv\" id={containerID}></Container>\r\n        );\r\n    }\r\n\r\n    // ESRI JSAPI\r\n    startup = (mapConfig, node, isScene = false) => {\r\n        createView(mapConfig, node, isScene).then(response => {\r\n            this.init(response);\r\n\r\n            this.setupWidgetsAndLayers();\r\n            this.finishedLoading();\r\n\r\n        }, error => {\r\n            console.error(\"maperr\", error);\r\n            window.setTimeout(() => {\r\n                this.startup(mapConfig, node);\r\n            }, 1000);\r\n        })\r\n    }\r\n\r\n    finishedLoading = () => {\r\n        // Update app state only after map and widgets are loaded\r\n        this\r\n            .props\r\n            .onMapLoaded(this.view.extent);\r\n    }\r\n\r\n    getSelectedSupport = (expandedMapPoint) => {\r\n        // this line takes the buffered point and sends it  to the map reducer which\r\n        // punts it to the _setSupport saga which queries and gets the support, signs,\r\n        // timebands, etc and writes them to the store, where they dictate the Rightbar\r\n        // display.  Once the store changes the action picks up in willReceiveProps\r\n\r\n        this\r\n            .props\r\n            .onMapClicked(expandedMapPoint, layerURLs(this.props));\r\n\r\n    }\r\n\r\n    mapClickHandler = (evt) => {\r\n        // this redux call moves info about the view into the store so that an extent\r\n        // around the point can be calculated I don't think it changes, (todo) see about\r\n        // moving it to map load or something\r\n        this\r\n            .props\r\n            .setPointBuffer(this.view.width, this.view.extent.width, this.view.spatialReference);\r\n\r\n        // in any map app that's more than a viewer, the map click event is gonna be\r\n        // complicated so much so that I wrote this a month ago and it is already\r\n        // getting away from me so we shall comment.  The click event is first captured\r\n        // here then evaluated against the store to decide what it is supposed to do\r\n        switch (this.props.graphic.mapClickMode) {\r\n                //the click is supposed to select an existing support on the map\r\n            case mapModes.SELECT_SUPPORT_MODE:\r\n\r\n                // this creates a small extent buffer around the mapPoint to aid in the select\r\n                // query its callback is getSelectedSupport, above\r\n                pointToExtent(this.view.width, this.view.extent.width, this.view.spatialReference, evt.mapPoint, 12, this.getSelectedSupport);\r\n                break;\r\n                //ok now we are in add support mode\r\n            case mapModes.ADD_SUPPORT_MODE:\r\n                // we should create a 'fake' feature out of the map click event console.lg('map\r\n                // // click happens here')\r\n\r\n                const newSupportFeature = {\r\n                    atrributes: {},\r\n                    geometry: {\r\n                        x: evt.mapPoint.longitude,\r\n                        y: evt.mapPoint.latitude,\r\n                        type: 'point'\r\n                    }\r\n                }\r\n                //grabbing a local copy of the mapPoint.geom for the marker\r\n\r\n                this.setState({newSupportClickGeom: evt.mapPoint});\r\n                this\r\n                    .props\r\n                    .startStreetSmartViewer([newSupportFeature], layerURLs(this.props), 4326, 2248, this.props.graphic.viewWidth, this.props.graphic.viewExtentWidth, this.props.graphic.view_spatRef, true);\r\n                this\r\n                    .props\r\n                    .setMapClickMode(mapModes.SELECT_SUPPORT_MODE, 'default');\r\n                this.view.surface.style.cursor = \"default\";\r\n                break;\r\n            case mapModes.DRAW_MODE:\r\n                let draw,\r\n                    action;\r\n\r\n                loadModules(['esri/views/draw/Draw',\"esri/Graphic\"]).then(([Draw, Graphic]) => {\r\n\r\n                    function createPolygonGraphic(layer,vertices){\r\n                        layer.removeAll();\r\n                            \r\n                        var polygon = {\r\n                            type: \"polygon\", // autocasts as Polygon\r\n                            rings: vertices,\r\n                            spatialReference: this.view.spatialReference\r\n                        };\r\n\r\n                        var graphic = new Graphic({\r\n                            geometry: polygon,\r\n                            symbol: {\r\n                                type: \"simple-fill\", // autocasts as SimpleFillSymbol\r\n                                color: \"purple\",\r\n                                style: \"solid\",\r\n                                outline: { // autocasts as SimpleLineSymbol\r\n                                    color: \"white\",\r\n                                    width: 1\r\n                                }\r\n                            }\r\n                        });\r\n                        layer.add(graphic);\r\n                    }\r\n\r\n                    draw = new Draw({view: this.view});\r\n                    action = draw.create(\"polygon\");\r\n                    // PolygonDrawAction.vertex-add Fires when user clicks, or presses the \"F\" key.\r\n                    // Can also be triggered when the \"R\" key is pressed to redo.\r\n                    action.on(\"vertex-add\", function (evt) {\r\n                        createPolygonGraphic( this.drawExtentLayer, evt.vertices);\r\n                    });\r\n\r\n                    // PolygonDrawAction.vertex-remove Fires when the \"Z\" key is pressed to undo the\r\n                    // last added vertex\r\n                    action.on(\"vertex-remove\", function (evt) {\r\n                        createPolygonGraphic( this.drawExtentLayer,evt.vertices);\r\n                    });\r\n\r\n                    // Fires when the pointer moves over the view\r\n                    action.on(\"cursor-update\", function (evt) {\r\n                        createPolygonGraphic(this.drawExtentLayer, evt.vertices);\r\n                    });\r\n\r\n                    // Add a graphic representing the completed polygon when user double-clicks on\r\n                    // the view or presses the \"C\" key\r\n                    action.on(\"draw-complete\", function (evt) {\r\n                        createPolygonGraphic(this.drawExtentLayer, evt.vertices);\r\n                    });\r\n\r\n                });\r\n\r\n                break;\r\n            default:\r\n                return\r\n\r\n        }\r\n\r\n    }\r\n\r\n    mapMoveHandler = (evt) => {\r\n        this\r\n            .props\r\n            .onMapChanged(this.view.extent);\r\n    }\r\n\r\n    init = (response) => {\r\n        this.view = response.view\r\n        this.map = response.view.map;\r\n\r\n    }\r\n\r\n    setupWidgetsAndLayers = () => {\r\n        loadModules(['esri/layers/FeatureLayer', \"esri/layers/GraphicsLayer\", 'esri/Graphic']).then(([FeatureLayer, GraphicsLayer, Graphic]) => {\r\n\r\n            this.featureLayer = new FeatureLayer({\r\n                url: layerURLs(this.props).supports,\r\n                definitionExpression: \"SUPPORTSTATUS = 1\",\r\n                outFields: [\"*\"],\r\n                id: \"support\"\r\n            });\r\n            this.queryMarkerLayer = new GraphicsLayer();\r\n            this.markerLayer = new GraphicsLayer();\r\n            this.conicLayer = new GraphicsLayer();\r\n            this.drawExtentLayer = new GraphicsLayer();\r\n\r\n            //     this.map.basemap = baseMap;\r\n            this\r\n                .map\r\n                .addMany([this.featureLayer, this.queryMarkerLayer, this.markerLayer, this.conicLayer, this.drawExtentLayer]);\r\n            this\r\n                .view\r\n                .on(\"click\", this.mapClickHandler);\r\n\r\n            this\r\n                .view\r\n                .on(\"pointer-up\", this.mapMoveHandler);\r\n            this\r\n                .view\r\n                .on('mouse-wheel', this.mapMoveHandler)\r\n\r\n            this.symb = {\r\n                type: \"simple-marker\", // autocasts as new SimpleMarkerSymbol()\r\n                style: \"circle\",\r\n                color: [\r\n                    0, 255, 0, 0.0\r\n                ],\r\n                size: \"30px\", // pixels\r\n                outline: { // autocasts as new SimpleLineSymbol()\r\n                    color: 'magenta',\r\n                    width: 3 // points\r\n                }\r\n            };\r\n            this.addSymb = {\r\n                type: \"simple-marker\", // autocasts as new SimpleMarkerSymbol()\r\n                style: \"circle\",\r\n                color: [\r\n                    0, 255, 0, 0.0\r\n                ],\r\n                size: \"30px\", // pixels\r\n                outline: { // autocasts as new SimpleLineSymbol()\r\n                    color: 'green',\r\n                    width: 3 // points\r\n                }\r\n            };\r\n            this.marSymb = {\r\n                type: \"simple-marker\", // autocasts as new SimpleMarkerSymbol()\r\n                style: \"square\",\r\n                color: [\r\n                    0, 255, 0, 0.0\r\n                ],\r\n                size: \"30px\", // pixels\r\n                outline: { // autocasts as new SimpleLineSymbol()\r\n                    color: 'green',\r\n                    width: 3 // points\r\n                }\r\n            };\r\n\r\n            this.selPoint = new Graphic({geometry: null, symbol: this.symb})\r\n\r\n            //   this.markerLayer.add(this.selPoint)\r\n        });\r\n    }\r\n\r\n}\r\n\r\nconst mapStateToProps = state => ({config: state.config, auth: state.auth, map: state.map, graphic: state.graphic});\r\n\r\nconst mapDispatchToProps = function (dispatch) {\r\n    return bindActionCreators({\r\n        ...mapActions,\r\n        ...graphicActions\r\n    }, dispatch);\r\n}\r\n\r\nexport default connect(mapStateToProps, mapDispatchToProps)(MapView);\r\n"]},"metadata":{},"sourceType":"module"}